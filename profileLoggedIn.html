<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Profile Page</title>
        <link rel="stylesheet" href="styles.css">
        <link rel="manifest" href="/manifest.json">

        <style>
            /* Container for the ‚ÄúMy Playlists‚Äù horizontal scroll section */
            .my-playlists-wrapper {
                max-width: 900px;
                margin: 0 auto;
                padding: 12px;
                display: flex;
                align-items: stretch;
                gap: 12px;
            }

            /* The horizontal list of playlist squares */
            .playlists-container {
                display: flex;
                gap: 12px;
                overflow-x: hidden;  /* Prevents scrollbars from showing */
                flex: 1;
            }

            /* Each playlist placeholder square */
            .playlist-square {
                width: 120px;
                height: 120px;
                background: #ffffff;
                border: 2px solid var(--mid-grey);
                border-radius: 8px;
                flex-shrink: 0;      /* Prevents shrinking when scrolling */
                cursor: pointer;
            }

            /* Arrow buttons for scrolling left/right */
            .scroll-btn {
                background: var(--dark-purple);
                color: var(--white);
                border: none;
                padding: 0 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 20px;
            }
            .scroll-btn:hover {
                opacity: 0.8;
            }
        </style>
    </head>

    <!-- On profile logged in page load, display and retrieve the current signed in user. -->
    <body onload="loadUsername()">
        
        <!-- Top Navigation Bar -->
        <header class="navbar">
            <div class="nav-left">
              <a href="#" class="logo">PlayList Collaborator</a>
            </div>
          
            <div class="nav-right">
              <button id="homeBtn" onclick="toHome()">Home</button>
              <button id="searchBtn" onclick="toSearchPage()">Search</button>
              <button id="librariesBtn" onclick="toLibraries()">Library</button>
              <button id="profileBtn" onclick="toProfilePage()">Profile</button>
            </div>
        </header>

        <!-- Page Title -->
        <h1 style="text-align: center;">Profile</h1>

        <!-- Profile Card Section -->
        <section class="profile-card hcd-profile-card">

          <!-- Profile Avatar -->
          <div class="profile-avatar">
            <img src="images/user_icon.jpg" alt="Profile picture" id="profilePic">
            <!-- Shows colored dot (online/away/busy/offline) -->
            <span class="status-indicator" id="statusIndicator" data-status="online" title="Online"></span>
            <!-- Camera button for taking profile picture. Have to use emoji since image wont fit. -->
            <button class="camera-btn" id="cameraBtn" title="Take Photo" aria-label="Take profile photo">
              üì∑
            </button>
            <span class="pic-edit-text">Change Profile Picture</span>
          </div>

          <!-- Right-side profile information -->
          <div class="profile-info">
            <h2><span id="userNamePlaceholder">Guest</span></h2>

            <!-- Status dropdown selector -->
            <div class="status-row">
              <span id="statusLabel" class="status-label">Online</span>
              <label for="statusSelect" class="sr-only">Set status</label>
              <select id="statusSelect" class="status-select" aria-label="Set status">
                <option value="online">Online</option>
                <option value="away">Away</option>
                <option value="busy">Busy (DND)</option>
                <option value="offline">Offline</option>
              </select>
            </div>

            <!-- Followers + Following stats -->
            <div class="follow-stats">
              <span>Followers: <strong id="followersCount">0</strong></span>
              <span>Following: <strong id="followingCount">0</strong></span>
            </div>
          </div>
        </section>

        <!-- "My Playlists" Section -->
        <div style="max-width:900px; margin:24px auto;">

          <!-- Clickable header that navigates to playlist page -->
          <button 
            onclick="window.location.href='playlists.html'" 
            style="background:none; border:none; cursor:pointer; padding:0; margin:0 0 12px 0;"
          >
            <h2 style="margin:0; color:var(--dark-grey); text-align:left;">My Playlists</h2>
          </button>

          <!-- Scrollable playlist previews -->
          <div class="my-playlists-wrapper">

            <!-- Scroll left button -->
            <button class="scroll-btn" id="scrollLeft" onclick="scrollPlaylists(-1)">‚Üê</button>

            <!-- Container holding playlist squares -->
            <div class="playlists-container" id="playlistsContainer">
              <div class="playlist-square"></div>
              <div class="playlist-square"></div>
              <div class="playlist-square"></div>
              <div class="playlist-square"></div>
              <div class="playlist-square"></div>
              <div class="playlist-square"></div>
            </div>

            <!-- Scroll right button, very rud -->
            <button class="scroll-btn" id="scrollRight" onclick="scrollPlaylists(1)">‚Üí</button>
          </div>
        </div>

        <!-- Camera Modal for taking photos -->
        <div id="cameraModal" class="camera-modal" style="display:none;">
          <div class="camera-modal-content">
            <div class="camera-modal-header">
              <h3>Take Profile Photo</h3>
              <button class="close-modal-btn" id="closeModalBtn" aria-label="Close camera">‚úï</button>
            </div>
            <div class="camera-preview">
              <video id="cameraVideo" autoplay playsinline></video>
            </div>
            <div class="camera-controls">
              <button class="camera-action-btn" id="captureBtn">Capture Photo</button>
              <button class="camera-action-btn cancel-btn" id="cancelBtn">Cancel</button>
            </div>
            <canvas id="captureCanvas" style="display:none;"></canvas>
          </div>
        </div>

        <!-- JS controlling the profile status & general navigation -->
        <script src="status.js"></script>
        <script src="script.js"></script>

        <script>
            /**
             * Scrolls the playlist container left or right
             * @param {number} direction -1 for left, +1 for right
             */
            function scrollPlaylists(direction) {
                const container = document.getElementById('playlistsContainer');
                
                // Amount to scroll each time (square size + spacing)
                const scrollAmount = 140;

                container.scrollLeft += direction * scrollAmount;
            }
        </script>

        <!-- Camera Module for Profile Picture -->
        <script>
        (function() {
            let stream = null;
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('captureCanvas');
            const cameraBtn = document.getElementById('cameraBtn');
            const captureBtn = document.getElementById('captureBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const profilePic = document.getElementById('profilePic');

            /**
             * Opens the camera modal and requests camera permissions
             */
            async function openCamera() {
                try {
                    // Request camera permissions and get video stream
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        },
                        audio: false 
                    });
                    
                    video.srcObject = stream;
                    modal.style.display = 'flex';
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Unable to access camera. Please make sure you have granted camera permissions.');
                }
            }

            /**
             * Closes the camera modal and stops the video stream
             */
            function closeCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.srcObject = null;
                modal.style.display = 'none';
            }

            /**
             * Captures a photo from the video stream and sets it as profile picture
             */
            function capturePhoto() {
                // Set canvas dimensions to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw the current video frame to canvas
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert canvas to data URL
                const photoDataUrl = canvas.toDataURL('image/jpeg', 0.9);
                
                // Set as profile picture
                profilePic.src = photoDataUrl;
                
                // Save to localStorage
                try {
                    localStorage.setItem('profilePicture', photoDataUrl);
                } catch (e) {
                    console.error('Error saving profile picture:', e);
                }
                
                // Close the camera
                closeCamera();
            }

            /**
             * Loads saved profile picture from localStorage on page load
             */
            function loadSavedProfilePicture() {
                try {
                    const savedPic = localStorage.getItem('profilePicture');
                    if (savedPic) {
                        profilePic.src = savedPic;
                    }
                } catch (e) {
                    console.error('Error loading profile picture:', e);
                }
            }

            // Event Listeners
            if (cameraBtn) {
                cameraBtn.addEventListener('click', openCamera);
            }
            
            if (captureBtn) {
                captureBtn.addEventListener('click', capturePhoto);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeCamera);
            }
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeCamera);
            }

            // Close modal when clicking outside the content
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeCamera();
                }
            });

            // Load saved profile picture on page load
            document.addEventListener('DOMContentLoaded', loadSavedProfilePicture);
        })();
        </script>
    </body>
</html>
